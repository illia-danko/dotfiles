#!/usr/bin/env python3

from sys import argv, stdin, stdout
from os.path import join
from os import getenv


def rgb2int(rgb, sep):
    v = int(rgb, 16)
    return sep.join(map(str, [v >> 16, (v & 0xFF00) >> 8, v & 0xFF]))


notes_preview_color = getenv("FZF_NOTES_PREVIEW_COLOR")
if not notes_preview_color:
    notes_preview_color = "ebdbb2"  # gruvbox-light

NOTES_PREVIEW_COLOR = "\033[48;2;{}m".format(rgb2int(notes_preview_color, ";"))
PURPLE = "\033[35m"
RED = "\033[31m"
BOLD = "\033[;1m"
RESET = "\033[0;0m"


def notes_shorten_line(basedir, line):
    filename, linenum, contents = line.split(sep=":", maxsplit=2)
    # It's is awful that relpath returns relative to the `current` dir, even if
    # a second arg is specified.
    p = filename.split(basedir)[1]
    if p[0] == "/":
        p = p[1:]
    return PURPLE + p + RESET + ":" + linenum + ":" + contents


def notes_preview(filename, line, height):
    with open(filename) as fd:
        for linenum, line_content in enumerate(fd, start=1):
            if line - linenum > (height / 2 - 1):
                continue
            if linenum == line:
                line_content = BOLD + NOTES_PREVIEW_COLOR + line_content + RESET
            stdout.write(line_content)


def todo_tags(filename):
    with open(filename) as fd:
        for linenum, line_content in enumerate(fd, start=1):
            if line_content.startswith("# TODO:"):
                stdout.write("{0}{1}: {2}".format(RED, linenum, line_content))


if __name__ == "__main__":
    mode = argv[1]
    if mode == "-ns":
        basedir = argv[2]
        for line in stdin:
            stdout.write(notes_shorten_line(basedir, line))
    elif mode == "-np":
        filename = join(argv[2], argv[3])
        line = int(argv[4])
        height = int(argv[5])
        notes_preview(filename, line, height)
    elif mode == "--todo-tags":
        todo_tags(argv[2])
